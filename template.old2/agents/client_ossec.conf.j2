<!--
  Wazuh - Agent - Default configuration for ubuntu 24.04
  More info at: https://documentation.wazuh.com
  Mailing list: https://groups.google.com/forum/#!forum/wazuh
  Generated By JinJa2
-->

{# 1. Try to find the agent's site group #}
{% set agent_site_group = group_names | select("match", "^site_.*_agent$") | list | first | default('') %}
{% if agent_site_group == '' %}
  {% set manager_ip = '127.0.0.1' %}
{% else %}
  {% set site_prefix = agent_site_group | regex_replace('_agent$', '') %}
  {% set lb_group = site_prefix + "_loadbalancer" %}
  {% set server_group = site_prefix + "_server" %}

  {# 2. Choose LB IP if it exists #}
  {% if lb_group in groups and groups[lb_group] | length > 0 %}
    {% set manager_host = groups[lb_group][0] %}
  {% else %}
    {% set master_servers = groups[server_group] | map('extract', hostvars) | selectattr('master', 'defined') | selectattr('master', 'equalto', 'true') | list %}
    {% if master_servers | length > 0 %}
      {% set manager_host = master_servers[0]['inventory_hostname'] %}
    {% else %}
      {% set manager_host = None %}
    {% endif %}
  {% endif %}

  {% if manager_host %}
    {% set manager_ip = hostvars[manager_host]['ansible_host'] %}
  {% else %}
    {% set manager_ip = '127.0.0.1' %}
  {% endif %}
{% endif %}

<ossec_config>
  <client>
    <server>
      <!-- Should either be MASTER NODE or LB -->
      <address>{{ manager_ip }}</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
    <config-profile>ubuntu, ubuntu24, ubuntu24.04</config-profile>
    <notify_time>10</notify_time>
    <time-reconnect>60</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>
